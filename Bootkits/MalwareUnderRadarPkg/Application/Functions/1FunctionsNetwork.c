#include <Uefi.h>
#include <Library/UefiBootServicesTableLib.h>
#include <Library/UefiLib.h>
#include <Library/MemoryAllocationLib.h>



#include <Library/NetLib.h>



#include <Protocol/ServiceBinding.h>
#include <Protocol/Tcp4.h>



EFI_STATUS
FunctionsNetwork_SetupNetwork(

)
{
    EFI_STATUS Status;
    EFI_HANDLE TcpHandle = NULL;
    EFI_HANDLE NetDeviceHandle;
    EFI_HANDLE *HandleBuffer;
    UINTN NumHandles;
    EFI_TCP4_PROTOCOL *TcpListener;
    EFI_IP4_MODE_DATA Ip4ModeData;
    EFI_SERVICE_BINDING_PROTOCOL *TcpServiceBinding;


    EFI_TCP4_CONFIG_DATA TcpConfigData = {
        0x00, // IPv4 Type of Service
        255,  // IPv4 Time to Live
        {
            // AccessPoint:
            TRUE,           // Use default address
            {{0, 0, 0, 0}}, // IP Address  (ignored - use default)
            {{0, 0, 0, 0}}, // Subnet mask (ignored - use default)
            0,              // Station port
            {{0, 0, 0, 0}}, // Remote address: accept any
            0,              // Remote Port: accept any
            TRUE            // ActiveFlag: act as a client (TRUE) not a sever (FALSE)
        },
        NULL // Default advanced TCP options
    };


    Status = gBS->LocateHandleBuffer(
        ByProtocol,
        &gEfiTcp4ServiceBindingProtocolGuid,
        NULL,
        &NumHandles,
        &HandleBuffer
    );


    NetDeviceHandle = HandleBuffer[0];


    Status = gBS->OpenProtocol(
        NetDeviceHandle,
        &gEfiTcp4ServiceBindingProtocolGuid,
        (VOID **)&TcpServiceBinding,
        gImageHandle,
        NULL,
        EFI_OPEN_PROTOCOL_GET_PROTOCOL
    );


    Status = TcpServiceBinding->CreateChild(
        TcpServiceBinding,
        &TcpHandle
    );


    Status = gBS->OpenProtocol(
        TcpHandle,
        &gEfiTcp4ProtocolGuid,
        (VOID **)&TcpListener,
        gImageHandle,
        NULL,
        EFI_OPEN_PROTOCOL_GET_PROTOCOL
    );


    if (Status == EFI_NO_MAPPING)
    {
        do
        {
            Status = TcpListener->GetModeData(
                TcpListener,
                NULL,
                NULL,
                &Ip4ModeData,
                NULL,
                NULL
            );
        } while (!Ip4ModeData.IsConfigured);

        Status = TcpListener->Configure(
            TcpListener,
            &TcpConfigData
        );
    }


    // Print(L"IP address: %d.%d.%d.%d\r\n",
    //     Ip4ModeData.ConfigData.StationAddress.Addr[0],
    //     Ip4ModeData.ConfigData.StationAddress.Addr[1],
    //     Ip4ModeData.ConfigData.StationAddress.Addr[2],
    //     Ip4ModeData.ConfigData.StationAddress.Addr[3]
    //);


    FreePool(HandleBuffer);


    return EFI_SUCCESS;
}