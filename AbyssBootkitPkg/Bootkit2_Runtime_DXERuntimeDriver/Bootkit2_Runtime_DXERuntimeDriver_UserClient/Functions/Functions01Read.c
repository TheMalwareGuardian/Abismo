// --------------------------------------------------------------------------------------------------------------------------------------------
// --------------------------------------------------------------------------------------------------------------------------------------------



// START -> LIBRARIES -------------------------------------------------------------------------------------------------------------------------
// START -> LIBRARIES -------------------------------------------------------------------------------------------------------------------------



#include <windows.h>
#include <stdio.h>



// START -> LOCAL -----------------------------------------------------------------------------------------------------------------------------
// START -> LOCAL -----------------------------------------------------------------------------------------------------------------------------



#include "Utils/Utils03Communication.h"
#include "../Globals/Globals01Operations.h"
#include "../Structures/Structures00Execution.h"



// START -> FUNCTIONS -------------------------------------------------------------------------------------------------------------------------
// START -> FUNCTIONS -------------------------------------------------------------------------------------------------------------------------



// Read <bytes> from kernel address <addr>
int FunctionsRead_CommandReadMemory(ULONGLONG addr, DWORD bytes)
{
	// -----------------------------------------------------------------------------------------------------------------
	// Sanity-check size
	if (bytes == 0 || bytes > 0x10000)
	{
		wprintf(L"[-] Read size must be 1-0x10000 bytes\n");
		return 1;
	}


	// -----------------------------------------------------------------------------------------------------------------
	// Allocate local buffer to receive the data
	BYTE* localBuf = (BYTE*)malloc(bytes);
	if (!localBuf)
	{
		wprintf(L"[-] Out of memory\n");
		return 1;
	}
	ZeroMemory(localBuf, bytes);


	// -----------------------------------------------------------------------------------------------------------------
	// Request read memory
	if (!UtilsCommunication_RequestReadMemory(addr, localBuf, bytes))
	{
		free(localBuf);
		return 1;
	}


	// -----------------------------------------------------------------------------------------------------------------
	// Pretty-print the dump (hex + optional ASCII column)
	wprintf(L"[+] Read %lu byte(s) from 0x%llx:\n", bytes, addr);

	for (DWORD i = 0; i < bytes; ++i)
	{
		// Hex byte
		wprintf(L"%02X ", localBuf[i]);

		// Add ASCII column every 16 bytes
		if ((i + 1) % 16 == 0)
		{
			wprintf(L" ");
			for (DWORD j = i - 15; j <= i; ++j)
			{
				wprintf(L"%c", (localBuf[j] >= 0x20 && localBuf[j] <= 0x7E) ? localBuf[j] : '.');
			}
			wprintf(L"\n");
		}
	}


	// -----------------------------------------------------------------------------------------------------------------
	// Trailing ASCII line for sizes not multiple of 16
	if (bytes % 16)
	{
		int pad = (16 - (bytes % 16)) * 3;
		while (pad--) putchar(' ');
		wprintf(L" ");
		DWORD start = bytes & ~0xF;
		for (DWORD j = start; j < bytes; ++j)
		{
			wprintf(L"%c", (localBuf[j] >= 0x20 && localBuf[j] <= 0x7E) ? localBuf[j] : '.');
		}
		wprintf(L"\n");
	}


	// ---------------------------------------------------------------------------------------------------------------------
	// Free the buffer that was used to hold the data
	free(localBuf);


	// ---------------------------------------------------------------------------------------------------------------------
	// Return
	return 0;
}



// --------------------------------------------------------------------------------------------------------------------------------------------
// --------------------------------------------------------------------------------------------------------------------------------------------
